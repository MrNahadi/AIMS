# AIMS Backend API

FastAPI-based REST API for marine engine fault prediction with explainable AI.

## Overview

The backend serves a trained LightGBM model that classifies marine engine faults based on 18 sensor readings. It provides predictions with confidence scores and SHAP (SHapley Additive exPlanations) values for model interpretability.

## API Endpoints

### POST /predict

Accepts sensor readings and returns fault prediction with explanations.

#### Request

**URL**: `http://localhost:8000/predict`

**Method**: `POST`

**Content-Type**: `application/json`

**Request Body**:
```json
{
  "Shaft_RPM": 950.0,
  "Engine_Load": 70.0,
  "Fuel_Flow": 120.0,
  "Air_Pressure": 2.5,
  "Ambient_Temp": 25.0,
  "Oil_Temp": 75.0,
  "Oil_Pressure": 3.5,
  "Vibration_X": 0.05,
  "Vibration_Y": 0.05,
  "Vibration_Z": 0.05,
  "Cylinder1_Pressure": 145.0,
  "Cylinder1_Exhaust_Temp": 420.0,
  "Cylinder2_Pressure": 145.0,
  "Cylinder2_Exhaust_Temp": 420.0,
  "Cylinder3_Pressure": 145.0,
  "Cylinder3_Exhaust_Temp": 420.0,
  "Cylinder4_Pressure": 145.0,
  "Cylinder4_Exhaust_Temp": 420.0
}
```

#### Response

**Status Code**: `200 OK`

**Response Body**:
```json
{
  "prediction_label": "Normal",
  "probabilities": {
    "Normal": 0.9523,
    "Fuel Injection Fault": 0.0123,
    "Cooling System Fault": 0.0089,
    "Turbocharger Fault": 0.0067,
    "Bearing Wear": 0.0045,
    "Lubrication Oil Degradation": 0.0098,
    "Air Intake Restriction": 0.0034,
    "Vibration Anomaly": 0.0021
  },
  "shap_values": {
    "Shaft_RPM": -0.0234,
    "Engine_Load": 0.0123,
    "Fuel_Flow": -0.0089,
    "Air_Pressure": 0.0045,
    "Ambient_Temp": -0.0012,
    "Oil_Temp": -0.0567,
    "Oil_Pressure": 0.0234,
    "Vibration_X": -0.1234,
    "Vibration_Y": -0.0987,
    "Vibration_Z": -0.0876,
    "Cylinder1_Pressure": 0.0123,
    "Cylinder1_Exhaust_Temp": -0.0234,
    "Cylinder2_Pressure": 0.0098,
    "Cylinder2_Exhaust_Temp": -0.0187,
    "Cylinder3_Pressure": 0.0112,
    "Cylinder3_Exhaust_Temp": -0.0201,
    "Cylinder4_Pressure": 0.0134,
    "Cylinder4_Exhaust_Temp": -0.0223
  }
}
```

#### Error Responses

**Status Code**: `422 Unprocessable Entity`

Returned when request validation fails (missing fields, wrong types, etc.)

```json
{
  "detail": [
    {
      "loc": ["body", "Shaft_RPM"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

**Status Code**: `500 Internal Server Error`

Returned when prediction fails due to server error

```json
{
  "detail": "Prediction failed: [error message]"
}
```

### GET /

Health check endpoint.

**Response**:
```json
{
  "message": "AIMS API is running",
  "version": "1.0"
}
```

### GET /docs

Interactive API documentation (Swagger UI).

Visit `http://localhost:8000/docs` in your browser for interactive API testing.

### GET /redoc

Alternative API documentation (ReDoc).

Visit `http://localhost:8000/redoc` for a different documentation view.

## Model Artifacts

The backend requires three serialized model artifacts in the `backend/artifacts/` directory:

### 1. lgbm_model.pkl

The trained LightGBM classifier.

- **Type**: LightGBM Booster
- **Input**: 18 preprocessed sensor features
- **Output**: 8-class prediction (0-7)
- **Generated by**: `notebooks/03_Model_Training_Tuning.ipynb`

### 2. preprocessor.pkl

The fitted StandardScaler for input normalization.

- **Type**: sklearn.preprocessing.StandardScaler
- **Purpose**: Transforms raw sensor values to standardized features
- **Generated by**: `notebooks/02_Feature_Engineering_Preprocessing.ipynb`

### 3. shap_explainer.pkl

The SHAP TreeExplainer for generating feature importance values.

- **Type**: shap.TreeExplainer
- **Purpose**: Computes SHAP values for model predictions
- **Generated by**: `notebooks/04_Model_Explainability_Export.ipynb`

## Fault Label Mapping

The model predicts numeric labels (0-7) which are mapped to human-readable strings:

```python
FAULT_LABELS = {
    0: "Normal",
    1: "Fuel Injection Fault",
    2: "Cooling System Fault",
    3: "Turbocharger Fault",
    4: "Bearing Wear",
    5: "Lubrication Oil Degradation",
    6: "Air Intake Restriction",
    7: "Vibration Anomaly"
}
```

## Installation

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Ensure model artifacts exist in `backend/artifacts/` directory

3. Start the server from the **project root directory**:
```bash
uvicorn backend.main:app --reload --port 8000
```

**Important**: The server must be started from the project root directory (the directory containing both `backend/` and `frontend/` folders), not from within the `backend/` directory. This is required for Python to correctly resolve the absolute imports used throughout the backend package.

## Development

### Running with Auto-Reload

For development, use the `--reload` flag (run from project root):
```bash
uvicorn backend.main:app --reload
```

The server will automatically restart when code changes are detected.

### Running on a Different Port

```bash
uvicorn backend.main:app --port 8001
```

### Running in Production

For production deployment, remove the `--reload` flag and consider using multiple workers:
```bash
uvicorn backend.main:app --host 0.0.0.0 --port 8000 --workers 4
```

## Testing

Run backend tests with pytest (from project root):
```bash
pytest backend/tests/
```

Run with coverage:
```bash
pytest backend/tests/ --cov=backend --cov-report=html
```

## Project Structure

```
backend/
├── main.py                     # FastAPI application entry point
├── models/
│   ├── __init__.py
│   ├── request.py              # Pydantic request models
│   └── response.py             # Pydantic response models
├── services/
│   ├── __init__.py
│   └── predictor.py            # Prediction and SHAP logic
├── artifacts/
│   ├── lgbm_model.pkl          # Trained model
│   ├── preprocessor.pkl        # Fitted scaler
│   └── shap_explainer.pkl      # SHAP explainer
├── tests/
│   ├── __init__.py
│   ├── test_models.py          # Pydantic model tests
│   ├── test_predictor.py       # Prediction logic tests
│   └── test_endpoints.py       # API endpoint tests
├── requirements.txt
└── README.md
```

## Dependencies

Key dependencies (see `requirements.txt` for full list):

- **fastapi**: Web framework
- **uvicorn**: ASGI server
- **pydantic**: Data validation
- **lightgbm**: ML model
- **shap**: Explainability
- **scikit-learn**: Preprocessing
- **pandas**: Data manipulation
- **numpy**: Numerical operations
- **joblib**: Model serialization

## CORS Configuration

The API is configured to accept requests from `http://localhost:3000` (React frontend).

To modify CORS settings, edit the middleware configuration in `main.py`:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## API Usage Examples

### Using cURL

```bash
curl -X POST "http://localhost:8000/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "Shaft_RPM": 950.0,
    "Engine_Load": 70.0,
    "Fuel_Flow": 120.0,
    "Air_Pressure": 2.5,
    "Ambient_Temp": 25.0,
    "Oil_Temp": 75.0,
    "Oil_Pressure": 3.5,
    "Vibration_X": 0.05,
    "Vibration_Y": 0.05,
    "Vibration_Z": 0.05,
    "Cylinder1_Pressure": 145.0,
    "Cylinder1_Exhaust_Temp": 420.0,
    "Cylinder2_Pressure": 145.0,
    "Cylinder2_Exhaust_Temp": 420.0,
    "Cylinder3_Pressure": 145.0,
    "Cylinder3_Exhaust_Temp": 420.0,
    "Cylinder4_Pressure": 145.0,
    "Cylinder4_Exhaust_Temp": 420.0
  }'
```

### Using Python requests

```python
import requests

url = "http://localhost:8000/predict"
payload = {
    "Shaft_RPM": 950.0,
    "Engine_Load": 70.0,
    "Fuel_Flow": 120.0,
    "Air_Pressure": 2.5,
    "Ambient_Temp": 25.0,
    "Oil_Temp": 75.0,
    "Oil_Pressure": 3.5,
    "Vibration_X": 0.05,
    "Vibration_Y": 0.05,
    "Vibration_Z": 0.05,
    "Cylinder1_Pressure": 145.0,
    "Cylinder1_Exhaust_Temp": 420.0,
    "Cylinder2_Pressure": 145.0,
    "Cylinder2_Exhaust_Temp": 420.0,
    "Cylinder3_Pressure": 145.0,
    "Cylinder3_Exhaust_Temp": 420.0,
    "Cylinder4_Pressure": 145.0,
    "Cylinder4_Exhaust_Temp": 420.0
}

response = requests.post(url, json=payload)
print(response.json())
```

### Using JavaScript fetch

```javascript
const url = "http://localhost:8000/predict";
const payload = {
  Shaft_RPM: 950.0,
  Engine_Load: 70.0,
  Fuel_Flow: 120.0,
  Air_Pressure: 2.5,
  Ambient_Temp: 25.0,
  Oil_Temp: 75.0,
  Oil_Pressure: 3.5,
  Vibration_X: 0.05,
  Vibration_Y: 0.05,
  Vibration_Z: 0.05,
  Cylinder1_Pressure: 145.0,
  Cylinder1_Exhaust_Temp: 420.0,
  Cylinder2_Pressure: 145.0,
  Cylinder2_Exhaust_Temp: 420.0,
  Cylinder3_Pressure: 145.0,
  Cylinder3_Exhaust_Temp: 420.0,
  Cylinder4_Pressure: 145.0,
  Cylinder4_Exhaust_Temp: 420.0
};

fetch(url, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload)
})
  .then(response => response.json())
  .then(data => console.log(data));
```

## Troubleshooting

### ModuleNotFoundError: No module named 'models' or 'backend'

This error occurs when the server is started from the wrong directory or with the wrong command.

**Solution**: Always run the server from the **project root directory** (the directory containing both `backend/` and `frontend/` folders) using:
```bash
uvicorn backend.main:app --reload
```

**Why this is required**: The backend uses absolute imports (e.g., `from backend.models.request import SensorInput`) to ensure consistent module resolution across all execution contexts (development server, tests, production). Absolute imports require that:
1. The `backend/` directory is treated as a Python package
2. The command is run from a directory where Python can find the `backend` package
3. The uvicorn command references the module path as `backend.main:app`

**Common mistakes**:
- ❌ Running `uvicorn main:app` from the `backend/` directory
- ❌ Running `uvicorn backend.main:app` from inside the `backend/` directory
- ✅ Running `uvicorn backend.main:app` from the project root directory

### Model artifacts not found

Ensure you've run all Jupyter notebooks in order to generate the required .pkl files:
1. `01_Data_Exploration_Cleaning.ipynb`
2. `02_Feature_Engineering_Preprocessing.ipynb`
3. `03_Model_Training_Tuning.ipynb`
4. `04_Model_Explainability_Export.ipynb`

The server will start even if artifacts are missing, but predictions will fail. Check the console output for warnings about missing artifacts.

### Import errors (dependencies)

Make sure all dependencies are installed:
```bash
pip install -r backend/requirements.txt
```

If using a virtual environment, ensure it's activated before installing dependencies and starting the server.

### CORS errors

If the frontend can't connect, verify the CORS middleware configuration allows requests from your frontend URL. The default configuration allows requests from `http://localhost:3000`.

## Interactive Documentation

For the best API exploration experience, visit the Swagger UI at:

**http://localhost:8000/docs**

This provides:
- Interactive request testing
- Automatic request/response examples
- Schema documentation
- Try-it-out functionality
